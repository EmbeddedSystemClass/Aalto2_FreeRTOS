#include "igrf.h"
#include "global.h"

#define NCOEF 210 //max number of coefficients in IGRF
//static int  nyrs=2008, Nmax = 8;
double Gh[NCOEF] = {0.000000, 14754.063000, 801.265000, -2485.839000, 1192.364000     , -1312.174845     , 1162.665085     , -1443.172446     , 487.923909     , -1004.265000     , 1422.054944     , 102.983897     , -1195.433103     , -247.197035     , -1522.309398     , 1267.402939     , -1371.285000     , -956.737619     , -338.601671     , -294.171513     , 358.898973     , 1134.674145     , -503.721627     , -814.289221     , 2737.062479     , 863.550000     , -1035.951395     , -128.691491     , -776.321799     , -719.220666     , 880.174715     , 747.785815     , 2184.231446     , 51.035062     , 373.370636     , -4272.084092     , -820.800000     , -591.083526     , 177.912773     , -827.617017     , -503.321743     , 2337.625720     , -1009.567121     , 632.083217     , 1956.910114     , -935.099933     , -176.465559     , 19246.108424     , -13083.832981     , -3161.655000     , 2229.138081     , 1740.282611     , 149.097541     , 782.816770     , -2267.653213     , -342.524620     , -1167.828894     , -2136.460033     , -1743.023095     , -1331.290742     , -1030.534802     , 11954.901191     , -7026.756485     , 5950.233904     , -3843.000000     , -954.922500     , -1294.650000     , 1968.985248     , 2848.576392     , 1134.768864     , -2195.747166     , 5645.307526     , 5289.921469     , -6040.557109     , -8864.893958     , -12216.370140     , -8306.485815     , 42735.878801     , 35351.068406     , 49703.753792     , -17031.179489     , -3852.765000     , -5003.783477     , 10788.351581     , -2128.439566     , -7320.692315     , 4564.611922     , -10360.403818     , -4156.947974     , 8481.033432     , 24115.932791     , 15086.441719     , 3442.948120     , -31025.217890     , -75687.782769     , -20941.001276     , 209726.382053     , 167374.780312     , 1096660.767113     , -751661.279514     , 7207.987500     , 16462.514483     , -7038.092877     , -3046.824941     , 182.081172     , 5222.449395     , -17996.173769     , 1039.463085     , -24465.678513     , -22594.287297     , 61208.720105     , 2816.254193     , 15504.871983     , -69287.477284     , 124219.814246     , -252703.099687     , 138463.170267     , 202789.025224     , 496616.353932     , 2862874.634002     , 8860047.682205     , -58276.968750     , 21880.066433     , -1900.111032     , 33744.254263     , -27047.923651     , -32097.081572     , 12978.029156     , 12949.771318     , 53088.456441     , -19408.705621     , -38139.377858     , 56922.350064     , 31100.431864     , -57655.504935     , 343496.881515     , -530946.168065     , 370482.437272     , -146229.025184     , 1520172.574308     , -2053290.188729     , 4689004.036761     , -44426624.432434     , 19886644.287369     , 246751.312500     , 18762.882766     , 64551.202176     , -27381.665139     , -27770.057552     , -116304.155183     , -265906.023507     , 100844.502654     , 400523.920918     , -210799.423261     , -120654.933051     , 51890.738104     , -207562.952414     , -324510.004611     , -1319.146360     , 514467.080481     , -110808.294257     , 1184837.257482     , -894673.031160     , -1440575.472289     , 7317468.592197     , 20484653.878902     , 6328592.255271     , 2175694.289901     , -110960408.784934     , 145945.800000     , 499776.379136     , 441766.620843     , -187087.158030     , -190828.901190     , -282796.621528     , -1281610.220967     , 398140.966272     , 576617.951152     , -1547711.554998     , 1628148.177032     , 671100.072045     , 188079.001083     , -2853978.561639     , -1900243.953699     , 1432826.147451     , -824550.896175     , -5529025.369066     , -7173555.991661     , 339952.232797     , -13462108.418760     , -38653510.677713     , 19615214.373765     , 88387580.527215     , 174735447.657648     , 478424766.967061     , 1393672147.251875     , 0.000000     , 0.000000     , 0.000000     , 0.000000     , 0.000000     , 0.000000     , 0.000000     , 0.000000     , 0.000000     , 0.000000     , 0.000000     , 0.000000     , 0.000000     , 0.000000}; /* IGRF coefficients array */



static double absv(double *vec)
{

    register double sum = 0.0;
    register double *d1;

    for (d1 = vec; d1 < (vec + 3); ++d1)
	sum += *d1 * *d1;
	//TODO static INLINE arm_status arm_sqrt_f32
    return (sqrt(sum));
}



/* vector product c =  a x b */

static int cross(double *a, double *b, double *c)
{
    /* Function Body */
    c[0] = a[1] * b[2] - a[2] * b[1];
    c[1] = a[2] * b[0] - a[0] * b[2];
    c[2] = a[0] * b[1] - a[1] * b[0];
    return (0);
}



static int crossn (double *a, double *b, double *c)
{
    /* Local variables */
    register double *d1;
    register double x;

    /* Function Body */

    cross (a, b, c);
    x = absv (c);

    if (x >= 1e-30)
        for (d1 = c; d1 < c + 3; )
            *d1++ /= x;

    return (0);
}



void igrfmodel(VEC *bv, double *geo, double *Nmax_loc)
{
    /* Local variables */
    register double *d1, *d2;
    int imax, nmax, N;
    double  f, h[NCOEF]; /* KV */
    int i, k, m;
    double  s, x, y, z;
    int ihmax, ih, il;
    double  xi[3], rq;
    int ihm, ilm;
    double  srq;

    srq=absv(geo); //square root of position vector magnitude
    rq = srq*srq; //magnitude of vector
    
    N = (int) *Nmax_loc; // store the max order value in a local variable
    if (rq < .8) { // 0.8 * earth radius is the limit to determine the altitude to be above or below earth surface
      //printf ("igrf call below surface !!!\n");
    }
    
	
	// number of harmonics depends on the distance from the earth 
    rq = 1. / rq;
	//TODO static INLINE arm_status arm_sqrt_f32
    srq = sqrt(rq);
    if (rq < 0.25)
	nmax = (N - 3) * 4.0 * rq + 3;
    else
	nmax = N;
    
    
    //what is xi?

    for (d1 = xi, d2 = geo; d1 < xi + 3; )
	*d1++ = *d2++ * rq;//position unit vector
    
    ihmax = nmax * nmax; //total number of COEFFS including g and h coeffs
    imax = nmax + nmax - 2; //max index for m?
    il = ihmax + nmax + nmax;//max index for ?

    d1 = h + ihmax;	//max index address for h[NCOEF]
    d2 = Gh + ihmax; //max index address for Gh[NCOEF]
    for ( ; d1 <= h + il; )
	*d1++ = *d2++;//last 26 entries of h and Gh are made equal

    for (k = 0; k < 3; k += 2) {//runs only 2 times ... for 0 and 2
	i = imax;
	ih = ihmax;
	while (i >= k) {
	    il = ih - i - 1;
	    f = 2. / (double) (i - k + 2);
	    x = xi[0] * f;
	    y = xi[1] * f;
	    z = xi[2] * (f + f);
	    i += -2;
	    if (i >= 2) {
		for (m = 3; m <= i + 1; m += 2) {
		    ihm = ih + m;
		    ilm = il + m;
		    h[ilm+1] = Gh[ilm+1]+z*h[ihm+1]+x*(h[ihm+3]-h[ihm-1])-y*(h[ihm+2]+h[ihm-2]);
		    h[ilm] = Gh[ilm]+z*h[ihm]+x*(h[ihm+2]-h[ihm-2])+y*(h[ihm+3]+h[ihm-1]);
		}
		h[il+2] = Gh[il+2]+z*h[ih+2]+x*h[ih+4]-y*(h[ih+3]+h[ih]);
		h[il+1] = Gh[il+1]+z*h[ih+1]+y*h[ih+4]+x*(h[ih+3]-h[ih]);
	    } else if (i == 0) {
		h[il + 2] = Gh[il+2]+z*h[ih+2]+x*h[ih+4]-y*(h[ih+3]+h[ih]);
		h[il+1] = Gh[il+1]+z*h[ih+1]+y*h[ih+4]+x*(h[ih+3]-h[ih]);
	    }
	    h[il] = Gh[il]+z*h[ih]+(x*h[ih+1]+y*h[ih+2])*2.;
	    ih = il;
	}
    }

    s = h[0]*.5+(h[1]*xi[2]+h[2]*xi[0]+h[3]*xi[1])*2.;
    f = (rq+rq)*srq;
    x = f*(h[2]-s*(*(geo+0)))*1e-9;
    y = f*(h[3]-s*(*(geo+1)))*1e-9;
    z = f*(h[1]-s*(*(geo+2)))*1e-9;

    bv->ve[0] = x;
    bv->ve[1] = y;
    bv->ve[2] = z;
    /* *(bv+3) = sqrt(x*x+y*y+z*z); */ 	

}

